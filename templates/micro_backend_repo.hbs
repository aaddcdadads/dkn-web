#!/bin/bash

# 后端仓库初始化
# 设置仓库信息
repo_directory={{repoDirectory}}
repo_url={{backendRepoUrl}}
repo_name={{backendRepoName}}

# 模板仓库信息
backend_template_url={{backendTemplateRepoUrl}}
backend_template_name={{backendTemplateRepoName}}

# 进入仓库保存目录
cd $repo_directory

# 克隆微应用后端仓库代码
echo "clone $repo_url start"
time git clone $repo_url --quiet
echo "clone $repo_url success"

#克隆后端模板仓库代码
echo "===> 1.克隆后端模板仓库代码 start"
echo "git clone -b {{backendTemplateRepoBranch}} $backend_template_url "
time git clone -b {{backendTemplateRepoBranch}} $backend_template_url --quiet
echo "===> 1.克隆后端模板仓库代码 success"

#将模板仓库代码复制到微应用仓库中
echo "===> 2.将模板仓库代码复制到微应用仓库中 start"
#删除.git文件
rm -rf $backend_template_name/.git
#time rsync -azq --progress --exclude='.git' --exclude='.gitlab-ci.yml' $backend_template_name/ $repo_name
# 移动文件
time mv -f $backend_template_name/* $repo_name/ 
# 隐藏文件也需要复制
time cp -a $backend_template_name/. $repo_name/
echo "===> 2.将模板仓库代码复制到微应用仓库中 success"

# 拷贝init.sh脚本
cp {{initJeecgShPath}} $repo_name/init_jeecg.sh
# 初始化项目配置
echo "===> 3.初始化后端项目配置 start"
cd $repo_name
pwd
chmod a+x init_jeecg.sh
./init_jeecg.sh
echo "===> 3.初始化后端项目配置 success"

# system-module下面创建微应用业务代码包
mkdir -p jeecg-boot/jeecg-boot-module-system/src/main/java/org/jeecg/modules/{{projectCode}}
echo "微应用业务代码请放这里" > jeecg-boot/jeecg-boot-module-system/src/main/java/org/jeecg/modules/{{projectCode}}/README.md

# 同步nginx配置
echo "===> 5.同步nginx配置 start"
# 同步nginx配置到nginx server
rsync -az {{nginxConf}} {{nginxUser}}@{{nginxServer}}:/etc/nginx/sites-enabled/member/
# 重载nginx配置
ssh {{nginxUser}}@{{nginxServer}} "service nginx reload && exit"
echo "===> 5.同步nginx配置 success"


echo "~~后端仓库初始化完成~~"