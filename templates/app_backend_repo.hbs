#!/bin/bash

# 应用后端代码仓库初始化

# 文件夹基础目录
base_dir={{workdir}}

# 应用web仓库文件夹名称
target_dir={{targetDir}}
# 模板仓库信息
backend_template_url={{backendTemplateRepoUrl}}
backend_template_name={{backendTemplateRepoName}}

# 仓库gitlab clone地址列表 示例: dirs=("ssh://xx1.git,ssh://xx2.git,ssh://xx3.git,ssh://xx4.git,ssh://xx5.git")
IFS=',' read -ra gitlab_urls <<< "{{gitlabUrls}}"

# 待合并的微应用仓库文件夹名列表 示例: dirs=("dir2,dir3,dir4,dir5")
IFS=',' read -ra merge_dirs <<< "{{mergeDirs}}"

# 进入工作目录
cd $base_dir

# 克隆仓库代码
echo "===> 1.克隆后端仓库代码 start"
echo "clone 模板仓库 git clone -b {{backendTemplateRepoBranch}} $backend_template_url "
time git clone -b {{backendTemplateRepoBranch}} $backend_template_url --quiet

#克隆微应用仓库
for url in "${gitlab_urls[@]}"; do
    echo "===> clone  $url "
    time git clone $url --quiet
done
echo "===> 1.克隆后端仓库代码 success"


# 创建一个文件夹,用于存放所有微应用项目的父项目pom.xml文件
mkdir pom

# 合并merge_dirs文件夹到base_dir
echo "===> 2.合并后端仓库目录 start"
echo "合并模板仓库"
rm -rf $backend_template_name/.git
# 移动文件
time mv -f $backend_template_name/* $base_dir/$target_dir/ 
# 隐藏文件也需要复制
time cp -a $backend_template_name/. $base_dir/$target_dir/
#微应用仓库
for dir in "${merge_dirs[@]}"; do
    echo "合并微应用仓库 $dir "
    # 检查目录是否存在
    if [ -d "$base_dir/$dir" ]; then
        #删除目录中的.git 
        rm -rf $base_dir/$dir/.git
        #拷贝父项目pom.xml文件
        cp $base_dir/$dir/jeecg-boot/pom.xml pom/$dir.xml
        # 移动目录中的文件到 target_dir,这里mv命令无法覆盖非空文件夹
        # mv -f "$base_dir/$dir"/* "$base_dir/$target_dir/"
        # 隐藏文件也需要复制
        #time cp -a $base_dir/$dir/. $base_dir/$target_dir/
        time rsync -azq $base_dir/$dir/ $base_dir/$target_dir
        # 删除空目录
        # rmdir "$base_dir/$dir"
        echo "文件夹 $dir 已合并到 $target_dir"
    else
        echo "文件夹 $dir 不存在"
    fi
done
echo "===> 2.合并后端仓库目录 success"


echo "===> 3.初始化项目配置 start"
# 拷贝init.sh脚本、模板仓库初始化配置相关文件
cp -f {{initJeecgShPath}} $target_dir/init_jeecg.sh
cp -f $backend_template_name/jeecg-boot/docs/docker-compose.yml $target_dir/jeecg-boot/docs
cp -f $backend_template_name/jeecg-boot/deploy.sh $target_dir/jeecg-boot
cp -f $backend_template_name/jeecg-boot/docs/jeecgboot-vue3.conf $target_dir/jeecg-boot/docs
cp -f $backend_template_name/jeecg-boot/jeecg-boot-module-system/src/main/resources/application* $target_dir/jeecg-boot/jeecg-boot-module-system/src/main/resources

#进入仓库目录
cd $target_dir
pwd
chmod a+x init_jeecg.sh
./init_jeecg.sh
echo "===> 3.初始化项目配置 success"


echo "~~ 应用后端仓库初始化完成 ~~"